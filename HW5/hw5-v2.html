<!DOCTYPE html>
<html>
<head>
<style>
body {
	overflow: hidden
}
#info {
  position: absolute;
  top: 20px;
  width: 100%;
  padding: 10px;
  text-align: center;
  color: #ffff00
}
</style>
</head>
<body> 

<div id="info">Homework 5-v2 </div>
<script src="https://threejs.org/build/three.min.js"></script>
<script src="https://threejs.org/examples/js/controls/OrbitControls.js">
</script>
<script src="http://jyunming-chen.github.io/tutsplus/js/KeyboardState.js"></script>
<script src="https://raw.githack.com/mrdoob/three.js/dev/examples/js/geometries/TeapotGeometry.js"></script>
    

<script id="myVertexShader2" type="x-shader/x-vertex">
    uniform vec3 lightpos;  // world coordinate
    varying vec3 eyelightdir;
    varying vec3 eyenormal;   
    varying vec4 eyepos;
    
    void main() {
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);

        eyepos = modelViewMatrix * vec4 (position, 1.0);
        vec4 eyelightpos= viewMatrix * vec4 (lightpos, 1.0);
        eyelightdir =  eyelightpos.xyz - eyepos.xyz;
        eyenormal = normalMatrix * normal;
    }
</script>
<script id="myFragmentShader2" type="x-shader/x-fragment">
    varying vec3 eyelightdir;
    varying vec3 eyenormal;
    varying vec4 eyepos;
    
    void main() {
        float intensity = dot (normalize (eyenormal), normalize (eyelightdir));         if (intensity > 0.8)
        	intensity = 0.8;
        else if (intensity > 0.4)
         	intensity = 0.4;
        else
          intensity = 0.0;
        vec3 diffuse = intensity*vec3 (1,1,1);
    
        vec3 h = normalize(-normalize (eyepos.xyz) + normalize (eyelightdir));
        float shininess = 40.;    
        vec3 specular = pow (dot (eyenormal, h), shininess) *vec3 (1,0,0);
        //gl_FragColor = vec4(diffuse + specular, 1.0);
        gl_FragColor = vec4 (diffuse + vec3(0.2,0.3,0.8), 1.0);
    }
</script>

<script id="myVertexShader" type="x-shader/x-vertex">
 varying vec2 vUv;
 void main() {
 gl_Position = projectionMatrix* modelViewMatrix * vec4( position, 1.0);
 vUv = uv;
 }
</script>
<script id="myFragmentShader" type="x-shader/x-fragment">
 uniform sampler2D mytex;
 varying vec2 vUv;
 
 void main() {
   vec4 color = texture2D (mytex, vUv);
   if (color.r == 1.0 && color.g == 1.0)
   	  discard;
   else
   
      gl_FragColor = color;//texture2D (mytex, vUv);
   
 }
</script> 

<script>
javascript:(function(){var script=document.createElement('script');script.onload=function(){var stats=new Stats();document.body.appendChild(stats.dom);requestAnimationFrame(function loop(){stats.update();requestAnimationFrame(loop)});};script.src='https://mrdoob.github.io/stats.js/build/stats.min.js';document.head.appendChild(script);})()


var scene, renderer, camera;
var mesh, pointLight;
var keyboard = new KeyboardState();
var turn = true;
var angle = 0;
var meshes = [] ;


var sceneRTT , renderTarget;
var quad;
init();
animate();

function init() {
    var width = window.innerWidth;
    var height = window.innerHeight;

    renderer = new THREE.WebGLRenderer({
        antialias: true
    });
    renderer.setSize(width, height);
    document.body.appendChild(renderer.domElement);
    renderer.setClearColor(0x888888);

    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 10000);
    camera.position.y = 160;
    camera.position.z = 400;

    let controls = new THREE.OrbitControls(camera, renderer.domElement);

    //var gridXZ = new THREE.GridHelper(200, 20, 'red', 'white');
    //scene.add(gridXZ);

	//////////////////////////////
    sceneRTT = new THREE.Scene();
	pointLight = new THREE.PointLight(0xffffff);
	pointLight.position.set(0, 300, 200);
	sceneRTT.add(pointLight);
  
	renderTarget = new THREE.WebGLRenderTarget(
		1024, 1024, {
			minFilter: THREE.LinearFilter,
		magFilter: THREE.NearestFilter,
		format: THREE.RGBFormat
		}
	);
 
    let meshMaterial = new THREE.ShaderMaterial({
        uniforms: {
        lightpos: {type: 'v3', value: new THREE.Vector3()}
        },
        vertexShader: document.getElementById('myVertexShader2').textContent,
        fragmentShader: document.getElementById('myFragmentShader2').textContent
    });
    
	var offsetX = 20;
	var offsetZ = 20;
    //var geometry = new THREE.TorusKnotGeometry(20, 5, 100, 16);
    for(let i=0 ;i<100;i++){
		var geometry = new THREE.TeapotGeometry (5);
		mesh = new THREE.Mesh(geometry, meshMaterial);
		meshes.push(mesh);
		scene.add(mesh);
		meshes[i].position.y += 5;
	}

	for(let i = 0 ; i < 100; i++){
		meshes[i].position.x += -90+(i%10)*offsetX;
	}

	for(let i=0 ;i < 100;i++){
		meshes[i].position.z += -90+Math.floor(i/10)*offsetZ;
	}
	sceneRTT.add(meshes);
	
	////////////////////
	
	let plane = new THREE.PlaneBufferGeometry(300, 300);
	
	let rttmaterial = new THREE.ShaderMaterial({
    uniforms: {
      mytex: {
        type: "t",
        value: renderTarget.texture
      }
    },
    vertexShader: document.getElementById('myVertexShader').textContent,
    fragmentShader: document.getElementById('myFragmentShader').textContent
	});
	quad = new THREE.Mesh(plane,
		rttmaterial);
	
	scene.add(quad);
	
	//scene.add (new THREE.AxesHelper (50));
	
}

function animate() {
    keyboard.update();
    
    if (keyboard.down("Z")) turn = !turn;    
    if (turn) angle += 0.01;
    
    //pointLight.position.set(50 * Math.cos(angle), 80, 50 * Math.sin(angle));    
	for(let i=0 ;i<100;i++){

		meshes[i].material.uniforms.lightpos.value.copy (pointLight.position);
		meshes[i].rotation.y = 1.3*angle;
	
	}
    requestAnimationFrame(animate);
    render();
}

function render() {
	renderer.setRenderTarget (renderTarget);
	renderer.setClearColor(0xffff00);
	renderer.render(sceneRTT, camera);
	// render texture to quad
	renderer.setRenderTarget(null);
	renderer.setClearColor(0x888888);
	renderer.render(scene, camera);
  
  
    renderer.render(scene, camera);
	quad.lookAt (camera.position);

}

</script>
</body>
</html>